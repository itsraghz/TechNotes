# SpringBoot MicroServices - Session by Mr Raghu, Naresh IT

Free Session  \
20 Feb 2022 Sun \
* Slot 1 : 07 00 AM IST - 08 30 AM IST
* Slot 2 : 09 30 AM IST - 10 30 AM IST

> New Classroom Link : https://classroom.google.com/u/0/c/NDA2NDE1MDg1MzAz

# Agenda

* SpringBoot MongoDB

# Lecture Notes - downloaded from Google Classroom

* URL to the classroom notes : https://classroom.google.com/u/0/c/NDA2NDE1MDg1MzAz/m/NDczNzExMTc3MTYx/details

## Contents
```
        Date : 20-02-2022
				Spring Boot: MongoDB
				   Mr. RAGHU
	-------------------------------------------------------
```  
				MongoDB

=> NoSQL Database, ie need not to define any SQL query.
   insted we use methods/commands.

=> Here, data is stored as JSON Format (Documents).
```
	-----------------------------------------------------
		SQL                      NoSQL
	------------------------------------------------------
	    Database                  Database
	    Tables                   Collections
	    Rows                      Documents(JSON)
	    Relations                 Embedded Docs
      Queires                    Methods
	-----------------------------------------------------
```
*) Scaling: Improve performance of system/app by enhance them
 Horizontal Scaling: NoSQL Database
 Vertical Scaling  : SQL Database

====================================================================
*) Schema less database:-
  In SQL Dbs first we need to create table then we can insert/update rows
  But in NoSQL perform CRUD Operations without creating Collection.
  Collection creation and modifications are done by default, no need to
  create it manually.

*) JSON Example:
```
{
  "_id"  : "78388AB-65FFA-3668-AA",
  "name" : "AJAY",
  "sal"  : 300.25,

  "addr" : {
                 "hno": "5-85/T",
		 "loc": "AMPT,HYD"

           }
   "clients" : [
                   {
		      "name" : "NIT",
		      "proj" : "XYZ
		   },
                   {
		      "name" : "AAA",
		      "proj" : "BBB
		   }

               ]

}
```

*) _id is PrimaryKey, default type is String, hexadecimal value(0-9,A-F).
  We can even use some other type like int,double...etc

*) if type is string, then auto-generated with hexadecimal concept.
============================================================================
Setup:-
1. Download and install
Goto : https://www.mongodb.com/try/download/community
Select Details : Version, Platform, Package ..etc
Click on Download Button
> Next > next > Install > Uncheck [ ] Install MongoDB Compass > Next > finish
> Check location : C:\Program Files\MongoDB\Server\3.6\bin

2. Set PATH
> Goto Environment Variables > Add path
C:\Program Files\MongoDB\Server\3.6\bin
> Apply and Finish

3. Start server
*) create a folder C:/data/db
```
cmd> mongod
```
*) Starts on Port : 27017

4. Start Client
```
cmd> mongo
cmd> db
```
output: test

5. press ctrl+C (first client, then server) to stop them
===========================================================
*) Few MongoDB Commands:-
a. Find Current datbase name
> db

b. View all databases
> show dbs

c. create/switch to you database
> use <databasename>
ex:
> use nitdb

d. Insert data into Collection(table)
> db.<collectionName>.<method>(<inputs>)

> db.student.insert({sid:200,sname:"AJAY",sfee:500.0});

e. view all documents(All rows)

> db.<collectionName>.find();
ex:
> db.student.find();
> db.student.find().pretty();

> db.student.find({sid:10}); //fetch one row data

f. View all collections
> show collections

g. drop a collection
> db.student.drop();

> db.student.delete({sid:10}); //delete one row

h. Drop database
> db.dropDatabase();

======================================================================
*) @Id indicates PK type, if your type is String then need not provide this

  @Id
  private String id;  //is optional , this is default

*) Collectioname(Table name) is optional, default takes classname
  we can override this:
    @Document(collection = "employee") //optinal

*) java.net.ConnectException: Connection refused: connect
 Solution:  Start MongoDB Server

*) if _id is generated by MongoDB then you can see it like:  ObjectId(_____)

ex:
 "_id" : ObjectId("6211a6b974471e07a554025d")

 We can provide our own value, in that case ID is not generated.
 "_id" : "AA1234"

=====Full Example===============================================
Name : *SpringBootMongoDbbasicFirstEx*
Dep  : Lombok, Spring Data MongoDB

1. application.properties
```
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=nitdb
#spring.data.mongodb.username=
#spring.data.mongodb.password=
```
2. collection class (Entity)
```java
package in.nareshit.raghu.collection;

import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import lombok.Data;

@Data
@Document(collection = "employee") //optinal
public class Employee {

	@Id
	private String id; //recomanded to specify PK

	private Integer eid;
	private String ename;
	private Double esal;
}
```
3. Repository Interface
```java
package in.nareshit.raghu.repo;

import org.springframework.data.mongodb.repository.MongoRepository;

import in.nareshit.raghu.collection.Employee;

public interface EmployeeRepository
	extends MongoRepository<Employee, String> {

}
```

4. Runner class
```java
package in.nareshit.raghu.runner;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import in.nareshit.raghu.collection.Employee;
import in.nareshit.raghu.repo.EmployeeRepository;

@Component
public class TestDataRunner implements CommandLineRunner {

	@Autowired
	private EmployeeRepository repo;

	public void run(String... args) throws Exception {
		Employee emp = new Employee();
		//emp.setId("AA1234");
		emp.setEid(2016);
		emp.setEname("SAM");
		emp.setEsal(600.25);

		repo.save(emp);
	}
}
```
===Ex#2 Crud Operations================================================

1. Collection class
```java
package in.nareshit.raghu.collection;

import org.springframework.data.annotation.Id;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Product {

	@Id
	private Integer pid;
	private String pname;
	private Double pcost;
}
```

2. Repository Interface
```java
package in.nareshit.raghu.repo;

import org.springframework.data.mongodb.repository.MongoRepository;

import in.nareshit.raghu.collection.Product;

public interface ProductRepository
	extends MongoRepository<Product, Integer> {

}
```

3. Runner class
```java
package in.nareshit.raghu.runner;

import java.util.Arrays;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import in.nareshit.raghu.collection.Product;
import in.nareshit.raghu.repo.ProductRepository;

@Component
public class TestDataRunner implements CommandLineRunner {

	@Autowired
	private ProductRepository repo;

	public void run(String... args) throws Exception {

		repo.deleteAll();

		repo.save(new Product(101, "P1", 500.0));
		repo.save(new Product(102, "P2", 600.0));
		repo.save(new Product(103, "P3", 700.0));

		repo.saveAll(
				Arrays.asList(
						new Product(104, "P4", 800.0),
						new Product(105, "P5", 900.0),
						new Product(106, "P6", 400.0)
						)
				);

		repo.findAll().forEach(System.out::println);

		Optional<Product> opt = repo.findById(106);
		if(opt.isEmpty()) {
			System.out.println("NO DATA");
		} else {
			System.out.println(opt.get());
		}

		repo.deleteById(105);
	}
}
```
==============================================================================
Q) When should we choose NoSQL(MongoDB) over SQL Databases?
A)
  NoSQL usages:
```
   > No Complex Queries
   > Easy to use and performs operations using simple methods/commands
   > Schema less, schema is created/adjusted over opertations
   > it is faster in creation and modification of Documents
   > Horizontal Scaling is supoprted for Disributed databases.
   > Reactive Programming suported
     [Spring Boot Reactive Programming]
```

============================================================================
============================================================================
============================================================================
## MongoDB Security : user operations

*) MongoDB Database is created without any user credentials.
  [no user/pwd]

*) We can add one user with name, pwd and roles (read, readWrite, admin).

--commands------------------
```
cmd> mongod
cmd> mongo

> use nitdb
> db.createUser(
  {
    user : "RAGHU",
    pwd  : "NIT",
    roles: ["readWrite","dbAdmin"]
  }
)
```

*) Stop mongo client and mongoserver

*) start in secured mode
```
cmd> mongod --auth
cmd> mongo

> db
> use nitdb

> show collections
	error message:
        "ok" : 0,
        "errmsg" : "there are no users authenticated",
        "code" : 13,
        "codeName" : "Unauthorized"

*) Login now
> db.auth("RAGHU","NIT")

> show collections

*) Logout
> db.logout()
```

----------------------------------------------------------------------
*) IN Spring Boot application if we did not specify any user and pwd
  Then error is:
MongoCommandException: Command failed with error 13 (Unauthorized):
'there are no users authenticated' on server localhost:27017. The full response is {"ok": 0.0, "errmsg": "there are no users authenticated", "code": 13, "codeName": "Unauthorized"}


*) in application.properties we must add keys
```
spring.data.mongodb.username=RAGHU
spring.data.mongodb.password=NIT
```
============================================================================
MongoDB :
```
//select * from product where pname="P2";
db.product.find({pname:"P2"}).pretty();

$lt    <
$gt    >
$lte   <=
$gte   >=
$ne    !=
$in    in operator
$regex like
```
-------------------
```
//select * from product where id<=102
> db.product.find({  _id: { $lte:102}   }).pretty();

//select * from product where id!=102
> db.product.find({  _id: { $ne:102}   }).pretty();

> db.product.find({  _id: { $in: [102,103,104]}   }).pretty();


db.product.find(
 {} // conditions  (What is your where condition)
 {} //projections  (Which fields you want to select)
)
```
ex:
```
  //select id,name from product where pcost>?
  db..product.find(
     { pcost : { $gt:200.0} },
     { pname:1  }
    )
```
    1 indicates select field, 0 indicates do not select field
    by default _id(PK) is set to 1 , other field are set to 0

```
//SELECT pname,pcost from product where pcost > 580
db.product.find({ pcost : {$gt:580} }, { _id:0,pname:1,pcost:1} ).pretty();
```
===========================================================================
		Custom Query using Spring Boot : MongoDB
===========================================================================
```
{
  $or : [
           { field1 : ?0},
	   { field2 : ?1 }
	]
}

{
  $and : [
           { field1 : ?0},
	   { field2 : ?1 }
	]
}
```
----------------------------------
```
{
  $and : [
           {
		{
		  $or : [
		           { field1 : ?0},
			   { field2 : ?1 }
			]
		}
	   },
	   { field3 : ?1 }
	]
}
//where (field1=? or field2) and field3
```
Document:
```
https://docs.mongodb.com/v4.2/crud/
```

===Code Custom Query================================
Name : *SpringBootCustomQuery*
Dep  : Lombok, MongoDB

1. Collection class
```java
package in.nareshit.raghu.collection;

import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Document(collection = "book")
public class Book {

	@Id
	private Integer id;
	private String title;
	private Integer noOfPages;
	private String writer;
	private String category;
}
```

2. application.proeprties
```java
spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=nitdb

logging.level.org.springframework.data.mongodb.core.MongoTemplate=DEBUG
```

3. Repository
```java
package in.nareshit.raghu.repo;

import java.util.List;
import java.util.Optional;

import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.data.mongodb.repository.Query;

import in.nareshit.raghu.collection.Book;

public interface BookRepository extends MongoRepository<Book, Integer>{

	//fetch one by ID
	@Query("{ id: ?0 }") // WHERE id=?
	Optional<Book> getOneBook(Integer id);

	@Query(" { writer:?0, category : ?1 } ")
	//@Query("{ $and : [ { writer:?0} , {category : ?1 } ] }")
	List<Book> getBookByWriterAndCategory(String writer, String category);

	@Query("{ noOfPages : { $gt : ?0 } }")
	List<Book> getBooksGtNpgs(Integer pages);

	@Query("{ $or : [ { writer:?0} , {category : ?1 } ] }")
	List<Book> getBookByWriterOrCategory(String writer, String category);


	//----------------------------------------------------
	//select id, title, nps,writer from book where id=?
	@Query(value = "{ id: ?0 }", fields = "{ title:1, noOfPages:1, writer:1}")
	List<Book> getBookA(Integer id);

	//SELECT COUNT(*) ....
	@Query(value="{ writer: ?0}",count = true)
	Integer countDataB(String writer);

	@Query(value="{ writer: ?0}",exists = true)
	Boolean isBookExistByWriter(String writer);

	//@Query(value="{ writer: ?0}",sort = "{ title : 1} ") //1 ASC, -1 DESC
	@Query(value="{ writer: ?0}",sort = "{ title : -1} ") //1 ASC, -1 DESC
	List<Book> getDataSort(String writer);

	//delete from book where category=?
	@Query(value="{ category:?0 }",delete = true)
	Long deleteByCategory(String category);
}
```
4. Runner-1 for insert
```java
package in.nareshit.raghu.runner;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;

import in.nareshit.raghu.collection.Book;
import in.nareshit.raghu.repo.BookRepository;

//@Component
public class BookDataInsertRunner implements CommandLineRunner {

	@Autowired
	private BookRepository repo;

	public void run(String... args) throws Exception {
		repo.save(new Book(101, "Core Java", 250, "AJAY KUMAR", "Backend"));
		repo.save(new Book(102, "Adv Java", 150, "SYED AHMED", "Backend"));
		repo.save(new Book(103, "Spring", 190, "AJAY KUMAR", "Backend"));
		repo.save(new Book(104, "Microservices", 650, "AJAY KUMAR", "Backend"));

		repo.save(new Book(105, "HTML", 60, "SAM SUN", "Frontend"));
		repo.save(new Book(106, "Angular", 100, "AJAY KUMAR", "Frontend"));
		repo.save(new Book(107, "CSS", 115, "SAM SUN", "Frontend"));
		repo.save(new Book(108, "JQUERY", 100, "SYED AHMED", "Frontend"));
	}

}
```

5. Runner-2 for testing queries
```java
package in.nareshit.raghu.runner;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import in.nareshit.raghu.repo.BookRepository;

@Component
public class TestQueriesRunner implements CommandLineRunner {

	@Autowired
	private BookRepository repo;

	public void run(String... args) throws Exception {
		/*Optional<Book> opt = repo.getOneBook(108);
		if(opt.isEmpty()) {
			System.out.println("NO DATA");
		} else {
			System.out.println(opt.get());
		}*/

		//repo.getBookByWriterAndCategory("AJAY KUMAR", "Backend").forEach(System.out::println);

		//repo.getBooksGtNpgs(180).forEach(System.out::println);

		//repo.getBookByWriterOrCategory("AJAY KUMAR", "Backend").forEach(System.out::println);

		//repo.getBookA(105).forEach(System.out::println);;

		//System.out.println(repo.countDataB("SYED AHMED"));
		//System.out.println(repo.isBookExistByWriter("SYED AHMED"));

		//repo.getDataSort("AJAY KUMAR").forEach(System.out::println);;

		long count = repo.deleteByCategory("Frontend");
		System.out.println(count);

	}
}
```

=====================================================================
		 Embeeded and External Documents
=====================================================================
https://github.com/javabyraghu/SpringBoot2MongoDbComplexTypes


*) One Collection can have multiple values field or embedded document.


1. List, Set, Array Type
 Format :
    variable : [ values  ]

2. Map
   varibale : { k:v,k:v }

3. HAS-A Variable (without collection)

   hasAvaribale : { variable:value,  variable:value  }

4. DBRef : link another collection PK as FK(DBRef)


https://github.com/javabyraghu/SpringBoot2MongoDbComplexTypes

===Full Code===============================================
1. Collections
```java
package in.nareshit.raghu.collection;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Profile {

	private String code;
	private String format;
}
```
-----
```java
package in.nareshit.raghu.collection;

import java.util.List;
import java.util.Map;

import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.DBRef;
import org.springframework.data.mongodb.core.mapping.Document;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
@Document(collection  = "employee")
public class Employee {

	@Id
	private Integer id;
	private String name;

	private List<String> projs;
	//private Set<String> projs;
	//private String[] data;

	private Map<String,String> clients;

	private Address addr;

	private List<Profile> pobs;

	@DBRef
	private Department dob;
}
```
-----
```java
package in.nareshit.raghu.collection;

import org.springframework.data.annotation.Id;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Department {

	@Id
	private Integer id;
	private String code;
}

```
--------
```java
package in.nareshit.raghu.collection;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Address {

	private String hno;
	private String loc;
}
```

2. Repository
```java
package in.nareshit.raghu.repo;

import org.springframework.data.mongodb.repository.MongoRepository;

import in.nareshit.raghu.collection.Department;

public interface DepartmentRepository extends MongoRepository<Department, Integer> {

}
```
---------
```java
package in.nareshit.raghu.repo;

import org.springframework.data.mongodb.repository.MongoRepository;

import in.nareshit.raghu.collection.Employee;

public interface EmployeeRepository extends MongoRepository<Employee, Integer>{

}
```

3. Runner class
```java
package in.nareshit.raghu.runner;

import java.util.Arrays;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import in.nareshit.raghu.collection.Address;
import in.nareshit.raghu.collection.Department;
import in.nareshit.raghu.collection.Employee;
import in.nareshit.raghu.collection.Profile;
import in.nareshit.raghu.repo.DepartmentRepository;
import in.nareshit.raghu.repo.EmployeeRepository;

@Component
public class TestDataRunner implements CommandLineRunner {

	@Autowired
	private EmployeeRepository repo;

	@Autowired
	private DepartmentRepository drepo;


	public void run(String... args) throws Exception {
		repo.deleteAll();

		Department d1= new Department(4450, "DEV");
		drepo.save(d1);

		repo.save(new Employee(109, "AJAY",
				Arrays.asList("P1","P2","P3"),
				Map.of("C1","ABC","C2","XYZ"),
				new Address("9/A", "HYD"),
				Arrays.asList(new Profile("PF1", "AA"),new Profile("PF2", "AB")),
				d1
				)
				);
	}
}
```
